---
title: stock
date: 2021-06-07 18:39:07
tags:
  - stock
cover: https://cover.png
feature: true
---
# 金融量化交易

## 金融基本概念

股市指的是股票市场，股票市场指的是已经发行的股票转让、买卖和流通的场所，包括交易所市场和场外交易市场两大类别。它是建立在发行市场基础上的，又称作二级市场。

### 股市分为投资和投机

投资投的是资产，利润来自于资产的增值服务或者生产产品。具有长线持有的特点。
投机投的是机会，盈利来自于价格的波动空价差。
A股由于种种原因投机操作明显多于投资操作，可称为韭菜之乡，韭菜故居

#### 投资有风险，入市需谨慎，

![img.png](img.png)
图1-1

### A股

#### 大陆上市企业股票交易市场

收盘价：上一时刻的结束价格
开盘价：当前时刻的开始价格
T+1：当天买的股票当天不能卖掉，反之亦是 A股
T+0 当天买的当天能卖 港股，美股，不同于美股是限制次数进行T0操作，港股没有任何限制
涨停板/跌停板 此刻股价相比于昨日收盘价 增长了10% 即为涨停板 港股没有涨停跌停限制
图1-1中红色绿色的长方形方块是蜡烛图
![img_2.png](img_2.png)
![img_1.png](img_1.png)
k线 就是将所有蜡烛图画出来
融券 为借别人的股票
做空 看跌融券卖出，跌到预期再以低价买回股票还回去，中间的差价就是利润
做多 看涨融资买入股票，涨到预期再卖掉，还账

##金融量化交易  = 得到信号 + 量化交易

量化交易比传统交易强多少？
它能让你的交易效率提高百倍，量化交易之于传统交易方法，如同大型收割机之于锄头镰刀，机枪大炮之于刀剑棍棒。

也就是是说，传统交易方法是这样的：
![img_3.png](img_3.png)

而量化交易是这样的：

![img_4.png](img_4.png)

在金融最为发达的美国，量化交易已大行其道，占据了70%以上的股市成交量。
可以说量化交易是未来的趋势。
量化交易是做什么？

### 量化交易是做什么？

量化交易是指借助现代统计学和数学的方法，利用计算机技术来进行交易的证券投资方式。
便于理解的说，量化交易主要是做这样的事：

从一个灵感开始

灵感就是指那些你想验证的可能会盈利的方法，比如银行股可能是良好的投资品种、一旦跨过20日均线后股价会继续涨、流传许久的羊驼交易法等等。灵感获取的方式可以是阅读、听人说、自己悟等等。

这里我们以一个简单的情况为例进行讲解。比如你的灵感是这样的：

#### *如果股价显著低于近几日的平均价，则买入*

#### *如果股价显著高于近几日的平均价，则卖出*

现在，你想知道这样操作究竟会不会赚钱？
把灵感细化成明确的可执行的交易策略

一般灵感都很模糊，需要将其细化成明确的可执行的策略，目的是为了能得到确定的结果，以及为后续程序化准备。
继续以之前那个关于平均价的灵感为例：

#### *如果股价显著低于近几日的平均价，则买入*

#### *如果股价显著高于近几日的平均价，则卖出*

显然它是不够明确的。比如多低叫显著低于？多高叫显著高于？近几日究竟是几日？买入卖出是买卖多少？我们把它细化：

#### *如果股价低于近20日平均价10%，则用全部可用资金买入*

#### *如果股价高于近20日平均价10%，则卖出全部所持的该股票*

现在我们基本已经把之前的灵感细化成明确的可执行的交易策略

把策略转成程序
就是把明确后的策略通过编程转成程序，好让计算机能根据历史数据模拟执行该策略，以及能根据实际行情进行反应并模拟交易或真实交易。

简言之，就是把刚刚的策略翻译成计算机可识别的代码语言，即把这个：
写成类似这样的代码（下面的代码并不完全符合，只是展示下大概的样子）
![img_6.png](img_6.png)
然后平台会有拿真实数据进行测试利润

### 这个简单的双均线策略显然不太行

### 如何制定简单又准确的信号呢？

### 所有的信号基本都是基于对未来股价的预测，比如去年全球疫情爆发，傻子都知道股市得大跌。

如何猜的更准？k线看起来很像一个函数，至少股价与时间绝对有关系，比如 y=kx+b，如果他符合某个函数，是不是代表可以算出之后的y值。

那怎么找到这个函数呢，上机器学习
金融市场作为最早的采用机器学习（ML）市场之一。20世纪80年代以来，人们一直在使用ML以发现市场上的规律。
虽然ML在预测市场结果方面取得了巨大成功，但最近的深度学习并没有对金融市场的预测有多大帮助。

既然股价和时间是有关系的，至于是不是 y=kx+b 不同的数据结果不一样
k是趋势，b是平移
时间序列的不同分类
时间序列是按时间顺序排列的、随时间变化且相互关联的数据序列。分析时间序 列的方法构成数据分析的一个重要领域，即时间序列分析。 时间序列根据所研究的依据不同，可有不同的分类。

1．按所研究的对象的多少分，有一元时间序列和多元时间序列。

2．按时间的连续性可将时间序列分为离散时间序列和连续时间序列两种。

3．按序列的统计特性分，有平稳时间序列和非平稳时间序列。如果一个时间序列的概率分布与时间t无关，则称该序列为严格的（狭义的）平稳时间序列。如果序列的 一、二阶矩存在，而且对任意时刻t满足：

（1）均值为常数

（2）协方差为时间间隔  的函数。 则称该序列为宽平稳时间序列，也叫广义平稳时间序列。我们以后所研究的时间序列主 要是宽平稳时间序列。

4．按时间序列的分布规律来分，有高斯型时间序列和非高斯型时间序列。

确定性时间序列分析方法概述
时间序列预测技术就是通过对预测目标自身时间序列的处理，来研究其变化趋势 的。一个时间序列往往是以下几类变化形式的叠加或耦合。 我们常认为一个时间序列可以分解为以下四大部分：

（1）长期趋势变动。它是指时间序列朝着一定的方向持续上升或下降，或停留在 某一水平上的倾向，它反映了客观事物的主要变化趋势。

（2）季节变动。

（3）循环变动。通常是指周期为一年以上，由非季节因素引起的涨落起伏波形相 似的波动。

（4）不规则变动。通常它分为突然变动和随机变动。

三种时间序列模型
![img_7.png](img_7.png)

如果在预测时间范围以内，无突然变动且随机变动的方差  较小，并且有理由认 为过去和现在的演变趋势将继续发展到未来时，可用一些经验方法进行预测。
从统计角度来讲，时间序列就是随机过程（离散的情形叫随机序列）。因为是在时间轴上的随机变量集合{rt}{rt}，又叫时间序列。

注意，每一个时间点上是一个随机变量，有自己的分布。

##以下
我们平时看到的在时间轴上的曲线图，是给定时间段以及每个时间点的随机变量得到一个观测值后的数值序列。这个数值序列是千万种可能中的一种而已。

下图是沪深300自2018年1月1日至2019年12月13日的走势图。它每个时间点是指数的点数。这个走势图是某个时间序列的一个观测（因为历史只有一个，我们也只能观测到一种现实）。


    prices = get_price('000300.XSHG', start_date='2018-01-01', end_date='2019-12-13', frequency='daily', fields='close')
    fig = plt.figure(figsize=(10, 6))
    ax = fig.add_axes([0.2, 0.2, 1.2, 1.2])
    
    ax.plot(prices, color="blue", linewidth=1.5, linestyle="-", label=r'hs300')
    plt.legend(loc='upper right', frameon=False)

![img_8.png](img_8.png)
光看上图，我们看不出这个时间序列有啥规律可循。2018年年初到年底，有很明显的下降趋势（我们都知道为什么）；2019年至今又是一个上涨加盘整的趋势。不管怎么样，对于指数点数来说，我们看不出什么周期性和规律性。
###平稳性
研究者们觉得，对不那么上蹿下跳的时间序列进行分析应该更加靠谱。如果存在这样的时间序列，那么分析它们也许也能做出一定的预测。研究者们称这类时间序列为平稳时间序列。

要使得时间序列平稳，那么一个较为宽松的条件就是使它们的统计特征保持不变。下面是时间序列弱平稳性的要求：

时间序列rtrt是弱平稳的，那么：

均值平稳性：对于任意的tt，有E[rt]=μE[rt]=μ，其中μμ为常数；
二阶平稳性： 对于任意的tt及间隔kk，rtrt和rt−krt−k的协方差σ(rt,rt−k)=γkσ(rt,rt−k)=γk仅依赖kk；σ(rt,rt)=γ0σ(rt,rt)=γ0不随时间变化，是方差平稳的。
均值平稳性说的是序列在某个固定值上下波动；二阶平稳性说的是，两个子序列波动的相关性。如果时间间隔为0，就是单个时间点自身，它与自己肯定是相关的，其方差（或者波动的幅度）必须是固定的。如果时间间隔为k，那么这相距k的两个时间点的波动相关性只与k有关。

更为严格的，如果任意两个时间段内的子序列中的随机变量的联合概率分布是一样的，那么这类时间序列是严平稳的。这个条件比较难以达到。我们平时要求时间序列达到弱平稳的就够用了。

第2节的指数走势图看上去不那么“平稳”，那么我们看看它的日收益曲线如何（见下图）。


    import pandas as pd
    returns = {'return':{}}
    for i in range(len(prices)):
        current_price = prices.iloc[i,0]
        if i == 0:
            current_return = 0
        else:
            last_price = prices.iloc[i-1,0]
            current_return = (current_price-last_price)/last_price
        date = list(prices.index)[i]
        returns['return'][date] = current_return
    return_df = pd.DataFrame(returns, columns=['return'], index=list(prices.index))
    
    fig = plt.figure(figsize=(10, 6))
    ax = fig.add_axes([0.2, 0.2, 1.2, 1.2])
    ax.plot(return_df, color="blue", linewidth=1.5, linestyle="-", label=r'hs300-daily-returns')
    plt.legend(loc='upper right', frameon=False)

![img_9.png](img_9.png)
日收益曲线看上去比指数走势图要“平稳”一些，表现在：
（1）序列看上去都在某个值（均值，貌似是0）上下波动；
（2）序列似乎有个波动范围（方差），上图的单日波动都在6%以下（毕竟，个股单日涨跌停最大是10%）。

上述日收益曲线究竟是不是平稳还需要严格的检验，不同的数据有不同的处理方法

###以云南白药为例
####获取到的数据

                         open   close    volume       money     avg
    2021-01-05 09:31:00  126.58  127.55  630800.0  79983026.0  126.81
    2021-01-05 09:32:00  127.77  127.01  297200.0  37878716.0  127.40
    2021-01-05 09:33:00  127.03  127.49  172000.0  21865302.0  127.15
    2021-01-05 09:34:00  127.46  128.90  660600.0  84573005.0  128.05
    2021-01-05 09:35:00  128.90  128.97  513800.0  66119210.0  128.76
    2021-01-05 09:36:00  129.00  128.60  361200.0  46583028.0  128.96
    2021-01-05 09:37:00  128.60  129.29  268700.0  34703382.0  129.20

####将价格曲线画出来
![img_10.png](img_10.png)

求一阶差分

![img_13.png](img_13.png)

可以发现每分钟涨幅的波动在[-1,1]区间内，说明处理过的数据是线性回归的，且是平稳的
只要找出其的周期性规律就能构造时间序列模型

##自相关性
###找到
![img_14.png](img_14.png)

相关图
上面给出的相关系数（或者自相关系数）只与时间间隔有关。因此，我们可以把不同时间间隔的相关系数算出来并且绘制在图中。这个图就是相关图。

我们用statsmodels来绘制相关图。statsmodels是大部分用python的朋友做时间序列分析首选的工具包。下面绘制的相关图是上面沪深300自2018年1月1日至2019年12月13日的日收益率的相关图。

![img_15.png](img_15.png)

可以看到，当时间间隔为0的时候，相关系数为1，很显然，每个点和自己都是完全相关的。当时间间隔大于1，相关系数便只是在0附近波动，说明不同时间点的单日收益相关性不大。

图中浅蓝色区域是95%的置信区间，如果相关系数在置信区间内，我们可以认为这个间隔下的子序列是不相关的。图中有个别间隔的序列相关系数超过置信区间，说明子序列还不是完全不相关的。不过大致上，我们可以认为沪深300的单日收益和其它交易日关联度不大。
以金融价格为例，传统的时间序列模型比如ARIMA,ARIMA-GARCH等，只分析价格自身的变化，模型的形式为：



其中称为自身的滞后项。

但是VAR模型除了分析自身滞后项的影响外，还分析其他相关因素的滞后项对未来值产生的影响，模型的形式为：

![img_31.png](img_31.png)

其中就是其他因子的滞后项。


就是可以把VAR模型看做是集合多元线性回归的优点（可以加入多个因子）以及时间序列模型的优点（可以分析滞后项的影响）的综合模型。

VAR其实是一类模型，以上是最基础的VAR模型形式，其他还有SVAR,CVAR,VECM，同统称为VAR类模型。

换成云南白药
![img_21.png](img_21.png)
可以看出间隔为一的时候相关性最强，理论上可以通过对所有特征（变量）进行计算相关性验证，并且选择合适的特征进行筛选
或者对于股市，可以凭借经验选择，讲道理完全按照数据的表现来看也是可性的，

但是对于股市
###宁可确定性的亏，也不可稀里糊涂的赚
可以参照经验选择合适特征，不同公司的股票对于特征的选择会大相径庭
##多因子策略简介
所谓因子，通俗来讲就是一个“标准”，这个“标准”决定我们选择哪些股票，决定我们什么时候买入卖出，决定我们交易的份额。而多因子，顾名思义就是根据多个“标准”确定我们的投资策略，

最为经典的多因子模型之一当属Fama和French提出的三因子模型，而其基本思路为，

我们假定股票的超额收益率可以由市场风险，市值风险，账面市值比三个因素决定，因此我们将股票一个时期内的超额收益率对这三个因素进行回归，再将回归得到的参数对本时期内的超额收益率进行预测，比较真实值和预测值。如果预测值大于真实值，也就是说理论上的超额收益率应该大于当前的超额收益率，那么根据有效市场假说，未来的超额收益率应该上升，反之亦然。

除了最简单的三因子模型外，Fama和French还在2013年提出了五因子模型，对个股的超额收益率进行了更加细致的解读。

![img_22.png](img_22.png)

仅作参考，目前对于高频短线交易，这只股票的特殊性其实并不重要，关注的重心应该在股价，交易量以及换手率或蜡烛图。

参考云南白药 19年数据建模，仅选用价格和交易量和委托笔数 得到的价格准确度的误差在0-0.0016之间、

涨跌准确率在0.6左右，基本等于瞎猜

进行一阶差分后的准确度能达到0.7
并将预测的值和真实值画在一张图上
![img_24.png](img_24.png)
可以看出有很强的滞后性和过拟合，这是因为时间序列模型只能得对趋势进行预测，根据市场有效性假说
下一分钟会出现什么结果只有市场才能知道
仅仅使用时间序列模型预测，对于趋势性的大小预测是有效的，但对于趋势的变化永远滞后

## 如何解决这个问题呢？

首先分析这个问题的原因是选择的数据为上一分钟的结果并不知道中间发生了什么，进行预测前如果我们知道在开盘价出来后的股民下订单的量，其实就可以算出订单完成后的交易价格
从而预测出下一分钟的收盘价，也就相当于知道了这一分钟过后的价格跟现在的价格的区别，也就是知道了股价的涨跌。也就知道了财富密码

换句话说就是猜拳，我比你晚出0.5秒，我就能赢

有办法获得这个数据吗，当然不可能

但股市是个轮回，所以可以用 SVM进行预测涨跌：
svm支持向量机进行分类
不同于其他数据，当股市噪声量大于非噪声，就不能去除噪声

A股一般常见早上的股价波动性大，A股是可以在开盘前提交预购买的，

现有最优秀的不管是策略还是模型都不建议在早上开盘后进行交易

所以可以去除早上的时间，去除10分钟左右为佳

svm模型进行特征工程，对涨跌结果进行打标签：
![img_25.png](img_25.png)

选取蜡烛图的数据当作特征

![img_26.png](img_26.png)

股市的一分钟的涨跌即使预测准去率为100%，但对于市场没什么用，做交易的利润都被手续费扣掉了。而且波动性会很大

所以对于svm模型选用5分钟的数据进行计算

然后对数据进行划分数据集和归一化处理

![img_27.png](img_27.png)

训练：

![img_28.png](img_28.png)

然后求最优模型

![img_29.png](img_29.png)


利用常见模型进行选股预测

https://www.joinquant.com/research?url=%2Fdefault%2Fresearch%2Fredirect%3Fnext%3D%252Fuser%252F29163079743%252Fclone_url%253Ffilename%253D%25252F%2525E6%25259C%2525BA%2525E5%252599%2525A8%2525E5%2525AD%2525A6%2525E4%2525B9%2525A0%25252F%2525E6%25259C%2525BA%2525E5%252599%2525A8%2525E5%2525AD%2525A6%2525E4%2525B9%2525A0%2525E6%2525A8%2525A1%2525E5%25259E%25258B%2525E5%2525A4%2525A7%2525E6%2525AF%252594%2525E6%25258B%2525BC%252521.ipynb%2526url%253Dhttps%25253A%25252F%25252Ffile.joinquant.com%25252Fresearch%25252Fusers%25252F28269855609%25252Fshare2%25252F3f6fe713583e1a07d1e2625686ed6689.html


股价预测模型都搭好后可以进行策略模拟接受市场检验

一个基本的量化交易策略 需要有以下几个功能

止损，信号，交易，平仓（不隔夜，即使收盘前是亏损的仍然要平仓）

止损：
*防止涨跌停板
![img_35.png](img_35.png)
*正常止损
如果连续3次都亏损，就止损：
![img_32.png](img_32.png)
去计算当前价格和买入价格的差距，用以计算亏损率，
信号：
![img_33.png](img_33.png)

     ![img_34.png](img_34.png)

平仓
![img_36.png](img_36.png)







