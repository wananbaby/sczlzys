<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>DeepSort</title>
      <link href="//post/DeepSort.html"/>
      <url>//post/DeepSort.html</url>
      
        <content type="html"><![CDATA[<h2 id="deepsort算法原理以及代码解析"><a href="#deepsort算法原理以及代码解析" class="headerlink" title="deepsort算法原理以及代码解析"></a>deepsort算法原理以及代码解析</h2><h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>前边我们讲了sort算法的原理，并且指出了它的不足–IDsw过大，为了解决该问题，17年时候sort算法的团队又提出了DeepSort算法。Deepsort在原来Sort算法的基础上，改进了以下内容：</p><ol><li><strong>使用级联匹配算法</strong>：针对每一个检测器都会分配一个跟踪器，每个跟踪器会设定一个time_since_update参数。</li><li>添加马氏距离与余弦距离：实际上是针对运动信息与外观信息的计算。</li><li>添加深度学习特征：这一部分也就是ReID的模块，也是deepsort的亮点之一。</li></ol><h1 id="代码流程"><a href="#代码流程" class="headerlink" title="代码流程"></a>代码流程</h1><p>由于deepsort的流程和算法原理几乎和sort一样，只是说增加了上边三个特色，因此我们直接从代码开始讲起：</p><h2 id="整体流程图"><a href="#整体流程图" class="headerlink" title="整体流程图"></a>整体流程图</h2><p>算法的整体流程图如下所示：</p><p><img src="https://www.pianshen.com/images/545/b0cbe4ad215ed35dbfa132c1593046b1.png" alt="2020-07-13_161051"></p><h2 id="源码流程"><a href="#源码流程" class="headerlink" title="源码流程"></a>源码流程</h2><p><img src="https://www.pianshen.com/images/71/af537dfceaf6fb81594cedfd5a3b3ac7.png" alt="image-20200715113558645"></p><p>首先我们从主函数部分开始说起，主函数部分整体逻辑是比较简单的，首先是将命令行参数进行解析，解析的内容包括，MOTChanlleng序列文件所在路径、需要检测文件所在的目录等一系列参数。解析之后传递给run方法，开始运行。</p><p><img src="https://www.pianshen.com/images/358/521cb662866e1c5064d97d3a7268117e.png" alt="image-20200715113707665"></p><p>进入run函数之后，首先会收集流信息，包括图片名称，检测结果以及置信度等，后续会将这些流信息传入到检测框生成函数中，生成检测框列表。然后会初始化metric对象，metric对象简单来说就是度量方式，在这个地方我们可以选择两种相似度的度量方式，第一种叫做余弦相似度度量，另一种叫做欧拉相似度度量。通过metric对象我们来初始化追踪器。</p><p><img src="https://www.pianshen.com/images/97/35311fdac87e487736b6129be9a03491.png" alt="image-20200715113756738"></p><p>接着根据display参数开始生成对应的visuializer，如果选择将检测结果进行可视化展示，那么便会生成Visualization对象，我从这个类中可以看到，它主要是调用opencv image viewer来讲追踪的结果进行展示。如果display是false则会生成一个NoVisualization对象，它一个虚拟可视化对象，它以给定的顺序循环遍历所有帧以更新跟踪器，而无需执行任何可视化。两者主要区别其实就是是否调用opencv将图片展示出来。其实前边我们所做的一系列工作可以说都是准备的工作，实际上核心部分就是在执行这个run方法之后。此处我们可以看到，在run方法中传入了一个frame_callback函数，这个frame_callback函数可以说是整个算法的核心部分，每一帧的图片都会执行该函数。</p><p><strong>为什么这样说那？</strong></p><p>首先进入run函数之后我们会发现，无论当时选择是可视化操作还是非可视化操作，它的run函数最终都要调用frame_callback函数的，比如说Visualization中的run方法，它首先判断帧序号是否大于最大帧，如果大于最大帧，直接返回。否则回调执行frame_callback函数；同样的如果是NoVisualization对象，它的run方法也是类似的，也是调用frame_callback函数，然后帧序号加1。最后上边追踪结果处理完之后，然后将追踪的结果保存到对应的目录下边。</p><p><img src="https://www.pianshen.com/images/438/f51ced2eb7760664b0a838d9469fbde6.png" alt="image-20200715114107385"></p><p>上边我们说了frame_callback函数实际上是整个函数的核心内容。进入frame_callback函数，我们可以看到，它第一步是根据之前的参数，生成检测框列表，然后将置信度小于最小置信度阈值的检测框剔除掉。</p><p><img src="https://www.pianshen.com/images/12/f2877155a8c21312f2fdc7a0b7bc5954.png" alt="image-20200715114146972"></p><p>然后执行非极大值抑制。</p><p>什么叫做非极大值抑制那？</p><p>简单来说就是就是一个寻找局部最大值的过程，我们以下边检测框为例，我们可以看到在检测人脸的过程中可能会产生多个检测框，通过非极大值抑制，可以在局部范围内选择出那个得分最高的检测框，剔除掉其他得分低的检测框。</p><p><img src="https://www.pianshen.com/images/250/07b49e0cf831a75397fa40c447c34cb2.png" alt="image-20200715114206754"></p><p>接着调用predict函数执行预测操作，进入predict函数，我们可以看到，它其实主要就是对轨迹列表中所有的轨迹使用卡尔曼滤波算法进行状态的预测。接着调用update函数执行更新操作。在update函数中，主要如下几件事：</p><ol><li><p>根据之前预测的结果，进行匹配操作。在该开始匹配的时候都处于不确定态，然后若干次匹配之后，如果匹配成功的次数大于n_init的话，轨迹便会从初始态转换成确定态。如果一直没有匹配到检测框则会直接进入删除态。由于追踪的目标体可能会消失，因此就算进入到了确定态，如果在后续的匹配中多次没有匹配到，大于max_age的时候轨迹便会从确定态转换成删除态。一旦轨迹进入到删除态，则证明这个轨迹失效，后续便会被删除。</p></li><li><p>针对不同状态进行不同的操作</p><p>a) 对未匹配的tracker,调用mark_missed标记，后续会删除对应的轨迹</p><p>b) 针对未匹配的detection（检测框）。没有匹配到目标，因此检测框失配，进行初始化操作</p><p>c) 更新轨迹列表，得到最新的tracks</p><p>d) 更新处于确定态的trac_id</p><p>e) 最后对特征集更新。</p></li></ol><p>执行到此处当前帧的处理就完成了，直接帧序号加1，继续进行下一帧的操作。</p><h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>最后我们将代码整体原理整理成树图如下：</p><p>了便于大家阅读源码，我将源码的具体逻辑也整理成了一个树图：</p><p><img src="https://www.pianshen.com/images/925/5056cf308b21f9ae021eb5509cea3f85.png" alt="deep_sort_app"></p>]]></content>
      
      
      
        <tags>
            
            <tag> DeepSort </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>stock</title>
      <link href="//post/stock.html"/>
      <url>//post/stock.html</url>
      
        <content type="html"><![CDATA[<h1 id="金融量化交易"><a href="#金融量化交易" class="headerlink" title="金融量化交易"></a>金融量化交易</h1><h2 id="金融基本概念"><a href="#金融基本概念" class="headerlink" title="金融基本概念"></a>金融基本概念</h2><p>股市指的是股票市场，股票市场指的是已经发行的股票转让、买卖和流通的场所，包括交易所市场和场外交易市场两大类别。它是建立在发行市场基础上的，又称作二级市场。</p><h3 id="股市分为投资和投机"><a href="#股市分为投资和投机" class="headerlink" title="股市分为投资和投机"></a>股市分为投资和投机</h3><p>投资投的是资产，利润来自于资产的增值服务或者生产产品。具有长线持有的特点。<br>投机投的是机会，盈利来自于价格的波动空价差。<br>A股由于种种原因投机操作明显多于投资操作，可称为韭菜之乡，韭菜故居</p><h4 id="投资有风险，入市需谨慎，"><a href="#投资有风险，入市需谨慎，" class="headerlink" title="投资有风险，入市需谨慎，"></a>投资有风险，入市需谨慎，</h4><p><img src="https://www.sczlzys.com/img/stock/1.png" alt="1"><br>图1-1</p><h3 id="A股"><a href="#A股" class="headerlink" title="A股"></a>A股</h3><h4 id="大陆上市企业股票交易市场"><a href="#大陆上市企业股票交易市场" class="headerlink" title="大陆上市企业股票交易市场"></a>大陆上市企业股票交易市场</h4><p>收盘价：上一时刻的结束价格<br>开盘价：当前时刻的开始价格<br>T+1：当天买的股票当天不能卖掉，反之亦是 A股<br>T+0 当天买的当天能卖 港股，美股，不同于美股是限制次数进行T0操作，港股没有任何限制<br>涨停板/跌停板 此刻股价相比于昨日收盘价 增长了10% 即为涨停板 港股没有涨停跌停限制<br>图1-1中红色绿色的长方形方块是蜡烛图</p><p><img src="https://www.sczlzys.com/img/stock/3.jpg" alt="3"><br>k线 就是将所有蜡烛图画出来<img src="https://www.sczlzys.com/img/stock/4.jpg" alt="4"></p><p>融券 为借别人的股票<br>做空 看跌融券卖出，跌到预期再以低价买回股票还回去，中间的差价就是利润<br>做多 看涨融资买入股票，涨到预期再卖掉，还账</p><p>##金融量化交易  = 得到信号 + 量化交易</p><p>量化交易比传统交易强多少？<br>它能让你的交易效率提高百倍，量化交易之于传统交易方法，如同大型收割机之于锄头镰刀，机枪大炮之于刀剑棍棒。</p><p>也就是是说，传统交易方法是这样的：<br><img src="https://www.sczlzys.com/img/stock/1.jpg" alt="1"></p><p>而量化交易是这样的：</p><p><img src="https://www.sczlzys.com/img/stock/2.jpg" alt="2"></p><p>在金融最为发达的美国，量化交易已大行其道，占据了70%以上的股市成交量。<br>可以说量化交易是未来的趋势。<br>量化交易是做什么？</p><h3 id="量化交易是做什么？"><a href="#量化交易是做什么？" class="headerlink" title="量化交易是做什么？"></a>量化交易是做什么？</h3><p>量化交易是指借助现代统计学和数学的方法，利用计算机技术来进行交易的证券投资方式。<br>便于理解的说，量化交易主要是做这样的事：</p><p>从一个灵感开始</p><p>灵感就是指那些你想验证的可能会盈利的方法，比如银行股可能是良好的投资品种、一旦跨过20日均线后股价会继续涨、流传许久的羊驼交易法等等。灵感获取的方式可以是阅读、听人说、自己悟等等。</p><p>这里我们以一个简单的情况为例进行讲解。比如你的灵感是这样的：</p><h4 id="如果股价显著低于近几日的平均价，则买入"><a href="#如果股价显著低于近几日的平均价，则买入" class="headerlink" title="如果股价显著低于近几日的平均价，则买入"></a><em>如果股价显著低于近几日的平均价，则买入</em></h4><h4 id="如果股价显著高于近几日的平均价，则卖出"><a href="#如果股价显著高于近几日的平均价，则卖出" class="headerlink" title="如果股价显著高于近几日的平均价，则卖出"></a><em>如果股价显著高于近几日的平均价，则卖出</em></h4><p>现在，你想知道这样操作究竟会不会赚钱？<br>把灵感细化成明确的可执行的交易策略</p><p>一般灵感都很模糊，需要将其细化成明确的可执行的策略，目的是为了能得到确定的结果，以及为后续程序化准备。<br>继续以之前那个关于平均价的灵感为例：</p><h4 id="如果股价显著低于近几日的平均价，则买入-1"><a href="#如果股价显著低于近几日的平均价，则买入-1" class="headerlink" title="如果股价显著低于近几日的平均价，则买入"></a><em>如果股价显著低于近几日的平均价，则买入</em></h4><h4 id="如果股价显著高于近几日的平均价，则卖出-1"><a href="#如果股价显著高于近几日的平均价，则卖出-1" class="headerlink" title="如果股价显著高于近几日的平均价，则卖出"></a><em>如果股价显著高于近几日的平均价，则卖出</em></h4><p>显然它是不够明确的。比如多低叫显著低于？多高叫显著高于？近几日究竟是几日？买入卖出是买卖多少？我们把它细化：</p><h4 id="如果股价低于近20日平均价10-，则用全部可用资金买入"><a href="#如果股价低于近20日平均价10-，则用全部可用资金买入" class="headerlink" title="如果股价低于近20日平均价10%，则用全部可用资金买入"></a><em>如果股价低于近20日平均价10%，则用全部可用资金买入</em></h4><h4 id="如果股价高于近20日平均价10-，则卖出全部所持的该股票"><a href="#如果股价高于近20日平均价10-，则卖出全部所持的该股票" class="headerlink" title="如果股价高于近20日平均价10%，则卖出全部所持的该股票"></a><em>如果股价高于近20日平均价10%，则卖出全部所持的该股票</em></h4><p>现在我们基本已经把之前的灵感细化成明确的可执行的交易策略</p><p>把策略转成程序<br>就是把明确后的策略通过编程转成程序，好让计算机能根据历史数据模拟执行该策略，以及能根据实际行情进行反应并模拟交易或真实交易。</p><p>简言之，就是把刚刚的策略翻译成计算机可识别的代码语言，即把这个：<br>写成类似这样的代码（下面的代码并不完全符合，只是展示下大概的样子）<br><img src="https://www.sczlzys.com/img/stock/5.PNG" alt="5"><br>然后平台会有拿真实数据进行测试利润</p><h3 id="这个简单的双均线策略显然不太行"><a href="#这个简单的双均线策略显然不太行" class="headerlink" title="这个简单的双均线策略显然不太行"></a>这个简单的双均线策略显然不太行</h3><h3 id="如何制定简单又准确的信号呢？"><a href="#如何制定简单又准确的信号呢？" class="headerlink" title="如何制定简单又准确的信号呢？"></a>如何制定简单又准确的信号呢？</h3><h3 id="所有的信号基本都是基于对未来股价的预测，比如去年全球疫情爆发，傻子都知道股市得大跌。"><a href="#所有的信号基本都是基于对未来股价的预测，比如去年全球疫情爆发，傻子都知道股市得大跌。" class="headerlink" title="所有的信号基本都是基于对未来股价的预测，比如去年全球疫情爆发，傻子都知道股市得大跌。"></a>所有的信号基本都是基于对未来股价的预测，比如去年全球疫情爆发，傻子都知道股市得大跌。</h3><p>如何猜的更准？k线看起来很像一个函数，至少股价与时间绝对有关系，比如 y=kx+b，如果他符合某个函数，是不是代表可以算出之后的y值。</p><p>那怎么找到这个函数呢，上机器学习<br>金融市场作为最早的采用机器学习（ML）市场之一。20世纪80年代以来，人们一直在使用ML以发现市场上的规律。<br>虽然ML在预测市场结果方面取得了巨大成功，但最近的深度学习并没有对金融市场的预测有多大帮助。</p><p>既然股价和时间是有关系的，至于是不是 y=kx+b 不同的数据结果不一样<br>k是趋势，b是平移<br>时间序列的不同分类<br>时间序列是按时间顺序排列的、随时间变化且相互关联的数据序列。分析时间序 列的方法构成数据分析的一个重要领域，即时间序列分析。 时间序列根据所研究的依据不同，可有不同的分类。</p><p>1．按所研究的对象的多少分，有一元时间序列和多元时间序列。</p><p>2．按时间的连续性可将时间序列分为离散时间序列和连续时间序列两种。</p><p>3．按序列的统计特性分，有平稳时间序列和非平稳时间序列。如果一个时间序列的概率分布与时间t无关，则称该序列为严格的（狭义的）平稳时间序列。如果序列的 一、二阶矩存在，而且对任意时刻t满足：</p><p>（1）均值为常数</p><p>（2）协方差为时间间隔  的函数。 则称该序列为宽平稳时间序列，也叫广义平稳时间序列。我们以后所研究的时间序列主 要是宽平稳时间序列。 </p><p>4．按时间序列的分布规律来分，有高斯型时间序列和非高斯型时间序列。 </p><p> 确定性时间序列分析方法概述 <br>时间序列预测技术就是通过对预测目标自身时间序列的处理，来研究其变化趋势 的。一个时间序列往往是以下几类变化形式的叠加或耦合。 我们常认为一个时间序列可以分解为以下四大部分：</p><p>（1）长期趋势变动。它是指时间序列朝着一定的方向持续上升或下降，或停留在 某一水平上的倾向，它反映了客观事物的主要变化趋势。</p><p>（2）季节变动。</p><p>（3）循环变动。通常是指周期为一年以上，由非季节因素引起的涨落起伏波形相 似的波动。</p><p>（4）不规则变动。通常它分为突然变动和随机变动。 </p><p>如果在预测时间范围以内，无突然变动且随机变动的方差  较小，并且有理由认 为过去和现在的演变趋势将继续发展到未来时，可用一些经验方法进行预测。 <br>从统计角度来讲，时间序列就是随机过程（离散的情形叫随机序列）。因为是在时间轴上的随机变量集合{rt}{rt}，又叫时间序列。</p><p>注意，每一个时间点上是一个随机变量，有自己的分布。</p><p>##以下<br>我们平时看到的在时间轴上的曲线图，是给定时间段以及每个时间点的随机变量得到一个观测值后的数值序列。这个数值序列是千万种可能中的一种而已。</p><p>下图是沪深300自2018年1月1日至2019年12月13日的走势图。它每个时间点是指数的点数。这个走势图是某个时间序列的一个观测（因为历史只有一个，我们也只能观测到一种现实）。</p><pre><code>prices = get_price(&#39;000300.XSHG&#39;, start_date=&#39;2018-01-01&#39;, end_date=&#39;2019-12-13&#39;, frequency=&#39;daily&#39;, fields=&#39;close&#39;)fig = plt.figure(figsize=(10, 6))ax = fig.add_axes([0.2, 0.2, 1.2, 1.2])ax.plot(prices, color=&quot;blue&quot;, linewidth=1.5, linestyle=&quot;-&quot;, label=r&#39;hs300&#39;)plt.legend(loc=&#39;upper right&#39;, frameon=False)</code></pre><p><img src="https://www.sczlzys.com/img/stock/15.png" alt="15"><br>光看上图，我们看不出这个时间序列有啥规律可循。2018年年初到年底，有很明显的下降趋势（我们都知道为什么)；2019年至今又是一个上涨加盘整的趋势。不管怎么样，对于指数点数来说，我们看不出什么周期性和规律性。<br>###平稳性<br>研究者们觉得，对不那么上蹿下跳的时间序列进行分析应该更加靠谱。如果存在这样的时间序列，那么分析它们也许也能做出一定的预测。研究者们称这类时间序列为平稳时间序列。</p><p>要使得时间序列平稳，那么一个较为宽松的条件就是使它们的统计特征保持不变。下面是时间序列弱平稳性的要求：</p><p>时间序列rtrt是弱平稳的，那么：</p><p>均值平稳性：对于任意的tt，有E[rt]=μE[rt]=μ，其中μμ为常数；<br>二阶平稳性： 对于任意的tt及间隔kk，rtrt和rt−krt−k的协方差σ(rt,rt−k)=γkσ(rt,rt−k)=γk仅依赖kk；σ(rt,rt)=γ0σ(rt,rt)=γ0不随时间变化，是方差平稳的。<br>均值平稳性说的是序列在某个固定值上下波动；二阶平稳性说的是，两个子序列波动的相关性。如果时间间隔为0，就是单个时间点自身，它与自己肯定是相关的，其方差（或者波动的幅度）必须是固定的。如果时间间隔为k，那么这相距k的两个时间点的波动相关性只与k有关。</p><p>更为严格的，如果任意两个时间段内的子序列中的随机变量的联合概率分布是一样的，那么这类时间序列是严平稳的。这个条件比较难以达到。我们平时要求时间序列达到弱平稳的就够用了。</p><p>第2节的指数走势图看上去不那么“平稳”，那么我们看看它的日收益曲线如何（见下图）。</p><pre><code>import pandas as pdreturns = &#123;&#39;return&#39;:&#123;&#125;&#125;for i in range(len(prices)):    current_price = prices.iloc[i,0]    if i == 0:        current_return = 0    else:        last_price = prices.iloc[i-1,0]        current_return = (current_price-last_price)/last_price    date = list(prices.index)[i]    returns[&#39;return&#39;][date] = current_returnreturn_df = pd.DataFrame(returns, columns=[&#39;return&#39;], index=list(prices.index))fig = plt.figure(figsize=(10, 6))ax = fig.add_axes([0.2, 0.2, 1.2, 1.2])ax.plot(return_df, color=&quot;blue&quot;, linewidth=1.5, linestyle=&quot;-&quot;, label=r&#39;hs300-daily-returns&#39;)plt.legend(loc=&#39;upper right&#39;, frameon=False)</code></pre><p><img src="https://www.sczlzys.com/img/stock/6.png" alt="6"></p><p>日收益曲线看上去比指数走势图要”平稳”一些，表现在：<br>（1）序列看上去都在某个值（均值，貌似是0）上下波动；<br>（2）序列似乎有个波动范围（方差），上图的单日波动都在6%以下（毕竟，个股单日涨跌停最大是10%)。</p><p>上述日收益曲线究竟是不是平稳还需要严格的检验，不同的数据有不同的处理方法</p><p><img src="https://www.sczlzys.com/img/stock/7.png" alt="7"></p><p>###以云南白药为例<br>####获取到的数据</p><pre><code>                     open   close    volume       money     avg2021-01-05 09:31:00  126.58  127.55  630800.0  79983026.0  126.812021-01-05 09:32:00  127.77  127.01  297200.0  37878716.0  127.402021-01-05 09:33:00  127.03  127.49  172000.0  21865302.0  127.152021-01-05 09:34:00  127.46  128.90  660600.0  84573005.0  128.052021-01-05 09:35:00  128.90  128.97  513800.0  66119210.0  128.762021-01-05 09:36:00  129.00  128.60  361200.0  46583028.0  128.962021-01-05 09:37:00  128.60  129.29  268700.0  34703382.0  129.20</code></pre><p>####将价格曲线画出来</p><p>求一阶差分</p><p><img src="https://www.sczlzys.com/img/stock/6.png" alt="6"></p><p>可以发现每分钟涨幅的波动在[-1,1]区间内，说明处理过的数据是线性回归的，且是平稳的<br>只要找出其的周期性规律就能构造时间序列模型</p><p>##自相关性<br>###找到<br><img src="https://www.sczlzys.com/img/stock/6.jpg" alt="6"></p><p>相关图<br>上面给出的相关系数（或者自相关系数）只与时间间隔有关。因此，我们可以把不同时间间隔的相关系数算出来并且绘制在图中。这个图就是相关图。</p><p>我们用statsmodels来绘制相关图。statsmodels是大部分用python的朋友做时间序列分析首选的工具包。下面绘制的相关图是上面沪深300自2018年1月1日至2019年12月13日的日收益率的相关图。</p><p><img src="https://www.sczlzys.com/img/stock/6.jpg" alt="6"></p><p>可以看到，当时间间隔为0的时候，相关系数为1，很显然，每个点和自己都是完全相关的。当时间间隔大于1，相关系数便只是在0附近波动，说明不同时间点的单日收益相关性不大。</p><p>图中浅蓝色区域是95%的置信区间，如果相关系数在置信区间内，我们可以认为这个间隔下的子序列是不相关的。图中有个别间隔的序列相关系数超过置信区间，说明子序列还不是完全不相关的。不过大致上，我们可以认为沪深300的单日收益和其它交易日关联度不大。<br>以金融价格为例，传统的时间序列模型比如ARIMA,ARIMA-GARCH等，只分析价格自身的变化，模型的形式为：</p><p>其中称为自身的滞后项。</p><p>但是VAR模型除了分析自身滞后项的影响外，还分析其他相关因素的滞后项对未来值产生的影响，模型的形式为：</p><p><img src="https://www.sczlzys.com/img/stock/8.png" alt="8"></p><p>其中就是其他因子的滞后项。</p><p>就是可以把VAR模型看做是集合多元线性回归的优点（可以加入多个因子）以及时间序列模型的优点（可以分析滞后项的影响）的综合模型。</p><p>VAR其实是一类模型，以上是最基础的VAR模型形式，其他还有SVAR,CVAR,VECM，同统称为VAR类模型。</p><p>换成云南白药<br>可以看出间隔为一的时候相关性最强，理论上可以通过对所有特征（变量）进行计算相关性验证，并且选择合适的特征进行筛选<br>或者对于股市，可以凭借经验选择，讲道理完全按照数据的表现来看也是可性的，</p><p>但是对于股市<br>###宁可确定性的亏，也不可稀里糊涂的赚<br>可以参照经验选择合适特征，不同公司的股票对于特征的选择会大相径庭<br>##多因子策略简介<br>所谓因子，通俗来讲就是一个“标准”，这个“标准”决定我们选择哪些股票，决定我们什么时候买入卖出，决定我们交易的份额。而多因子，顾名思义就是根据多个“标准”确定我们的投资策略，</p><p>最为经典的多因子模型之一当属Fama和French提出的三因子模型，而其基本思路为，</p><p>我们假定股票的超额收益率可以由市场风险，市值风险，账面市值比三个因素决定，因此我们将股票一个时期内的超额收益率对这三个因素进行回归，再将回归得到的参数对本时期内的超额收益率进行预测，比较真实值和预测值。如果预测值大于真实值，也就是说理论上的超额收益率应该大于当前的超额收益率，那么根据有效市场假说，未来的超额收益率应该上升，反之亦然。</p><p>除了最简单的三因子模型外，Fama和French还在2013年提出了五因子模型，对个股的超额收益率进行了更加细致的解读。</p><p><img src="https://www.sczlzys.com/img/stock/7.jpg" alt="7"></p><p>仅作参考，目前对于高频短线交易，这只股票的特殊性其实并不重要，关注的重心应该在股价，交易量以及换手率或蜡烛图。</p><p>参考云南白药 19年数据建模，仅选用价格和交易量和委托笔数 得到的价格准确度的误差在0-0.0016之间、</p><p>涨跌准确率在0.6左右，基本等于瞎猜</p><p>进行一阶差分后的准确度能达到0.7<br>并将预测的值和真实值画在一张图上</p><p><img src="http://www.sczlzys.com/img/stock/9.png" alt="9"></p><p>以看出有很强的滞后性和过拟合，这是因为时间序列模型只能得对趋势进行预测，根据市场有效性假说<br>下一分钟会出现什么结果只有市场才能知道<br>仅仅使用时间序列模型预测，对于趋势性的大小预测是有效的，但对于趋势的变化永远滞后</p><h2 id="如何解决这个问题呢？"><a href="#如何解决这个问题呢？" class="headerlink" title="如何解决这个问题呢？"></a>如何解决这个问题呢？</h2><p>首先分析这个问题的原因是选择的数据为上一分钟的结果并不知道中间发生了什么，进行预测前如果我们知道在开盘价出来后的股民下订单的量，其实就可以算出订单完成后的交易价格<br>从而预测出下一分钟的收盘价，也就相当于知道了这一分钟过后的价格跟现在的价格的区别，也就是知道了股价的涨跌。也就知道了财富密码</p><p>换句话说就是猜拳，我比你晚出0.5秒，我就能赢</p><p>有办法获得这个数据吗，当然不可能</p><p>但股市是个轮回，所以可以用 SVM进行预测涨跌：<br>svm支持向量机进行分类<br>不同于其他数据，当股市噪声量大于非噪声，就不能去除噪声</p><p>A股一般常见早上的股价波动性大，A股是可以在开盘前提交预购买的，</p><p>现有最优秀的不管是策略还是模型都不建议在早上开盘后进行交易</p><p>所以可以去除早上的时间，去除10分钟左右为佳</p><p>svm模型进行特征工程，对涨跌结果进行打标签：<br><img src="https://www.sczlzys.com/img/stock/10.png" alt="10"></p><p>选取蜡烛图的数据当作特征</p><p>股市的一分钟的涨跌即使预测准去率为100%，但对于市场没什么用，做交易的利润都被手续费扣掉了。而且波动性会很大</p><p>所以对于svm模型选用5分钟的数据进行计算</p><p>然后对数据进行划分数据集和归一化处理</p><p>训练：</p><p>然后求最优模型</p><p>利用常见模型进行选股预测</p><p><a href="https://www.joinquant.com/research?url=/default/research/redirect?next=%252Fuser%252F29163079743%252Fclone_url%253Ffilename%253D%25252F%2525E6%25259C%2525BA%2525E5%252599%2525A8%2525E5%2525AD%2525A6%2525E4%2525B9%2525A0%25252F%2525E6%25259C%2525BA%2525E5%252599%2525A8%2525E5%2525AD%2525A6%2525E4%2525B9%2525A0%2525E6%2525A8%2525A1%2525E5%25259E%25258B%2525E5%2525A4%2525A7%2525E6%2525AF%252594%2525E6%25258B%2525BC%252521.ipynb%2526url%253Dhttps%25253A%25252F%25252Ffile.joinquant.com%25252Fresearch%25252Fusers%25252F28269855609%25252Fshare2%25252F3f6fe713583e1a07d1e2625686ed6689.html">https://www.joinquant.com/research?url=%2Fdefault%2Fresearch%2Fredirect%3Fnext%3D%252Fuser%252F29163079743%252Fclone_url%253Ffilename%253D%25252F%2525E6%25259C%2525BA%2525E5%252599%2525A8%2525E5%2525AD%2525A6%2525E4%2525B9%2525A0%25252F%2525E6%25259C%2525BA%2525E5%252599%2525A8%2525E5%2525AD%2525A6%2525E4%2525B9%2525A0%2525E6%2525A8%2525A1%2525E5%25259E%25258B%2525E5%2525A4%2525A7%2525E6%2525AF%252594%2525E6%25258B%2525BC%252521.ipynb%2526url%253Dhttps%25253A%25252F%25252Ffile.joinquant.com%25252Fresearch%25252Fusers%25252F28269855609%25252Fshare2%25252F3f6fe713583e1a07d1e2625686ed6689.html</a></p><p>股价预测模型都搭好后可以进行策略模拟接受市场检验</p><p>一个基本的量化交易策略 需要有以下几个功能</p><p>止损，信号，交易，平仓（不隔夜，即使收盘前是亏损的仍然要平仓）</p><p>止损：<br>    *防止涨跌停板<br><img src="https://www.sczlzys.com/img/stock/11.png" alt="11"><br>    *正常止损<br>    如果连续3次都亏损，就止损：<img src="http://www.sczlzys.com/img/stock/12.png" alt="12"></p><p>​        去计算当前价格和买入价格的差距，用以计算亏损率，</p><p>平仓<br><img src="https://www.sczlzys.com/img/stock/13.png" alt="13"></p><h1 id="以下感兴趣浏览"><a href="#以下感兴趣浏览" class="headerlink" title="以下感兴趣浏览"></a>以下感兴趣浏览</h1><p>基于机器学习的多因子选股策略</p><p>传统的多因子策略的研究更多的是用上涨或下跌的分类预测来实现。xfy先生写了一篇用市值回归思路的多因子策略<a href="https://www.joinquant.com/post/eb0ba54a63bb912d30ff9342f49d9cee?f=stydy&amp;m=algorithm%EF%BC%8C%E5%AF%B9%E6%88%91%E5%90%AF%E5%8F%91%E9%A2%87%E5%A4%A7%EF%BC%8C%E6%9C%AC%E6%96%87%E5%9C%A8xfy%E5%85%88%E7%94%9F%E7%9A%84%E5%9F%BA%E7%A1%80%E4%B8%8A%E5%81%9A%E8%BF%9B%E4%B8%80%E6%AD%A5%E7%9A%84%E7%A0%94%E7%A9%B6%E3%80%82%E5%85%88%E5%9C%A8%E6%AD%A4%E8%A1%A8%E7%A4%BA%E6%84%9F%E8%B0%A2%EF%BC%81">https://www.joinquant.com/post/eb0ba54a63bb912d30ff9342f49d9cee?f=stydy&amp;m=algorithm，对我启发颇大，本文在xfy先生的基础上做进一步的研究。先在此表示感谢！</a></p><h1 id="1-概要"><a href="#1-概要" class="headerlink" title="1.概要"></a>1.概要</h1><h2 id="1-1-研究内容"><a href="#1-1-研究内容" class="headerlink" title="1.1 研究内容"></a>1.1 研究内容</h2><p>本文试图采用统一的视角解释和测试各种不同的基于机器学习选股的量化投资策略，并分析它们应用于多因子模型的异同。具体而言，本文主要关注并讨论如下几个问题：<br>1.基于机器学习选股的量化投资策略的有效性的验证。本文所采用的策略是否能够有效地获得更高的收益率和更低的风险？<br>2.基于机器学习选股算法的选择问题。相比传统的线性回归，在其他条件不变的情况下，机器学习的算法能否对量化投资策略有进一步的提升？<br>3.因子组合和算法，持仓数和算法，市场风格和算法的匹配的问题。机器学习的算法在不同的因子组合下，或者是不同持仓数下，或者是不同的市场环境下的表现有什么差异？<br>4.算法调优问题。改变机器学习的算法的参数或者训练集的长度是否可以改善模型，提升投资的表现？</p><h2 id="1-2-研究思路"><a href="#1-2-研究思路" class="headerlink" title="1.2 研究思路"></a>1.2 研究思路</h2><p>本文基于机器学习的算法，对中证全指成分股进行选股及量化投资。样本的回测区间选取的是2014年1月1日到2018年7月31日。<br>首先对于基于机器学习选股的量化策略进行了有效性的验证和比较；<br>其次，对于不同因子组合的表现进行了比较；<br>然后，对于不同持仓数的表现进行了比较，得出不同策略下的最佳持仓数；<br>然后，根据不同市场切换风格，对策略进行比较，得出不同市场风格时的最佳策略；<br>最后，对策略进行参数调优和训练集长度的调节比较，对不同策略下的最佳参数和最佳训练集长度进行实证分析。</p><h1 id="2-模型构建及数据预处理"><a href="#2-模型构建及数据预处理" class="headerlink" title="2.模型构建及数据预处理"></a>2.模型构建及数据预处理</h1><h2 id="2-1-数据获取"><a href="#2-1-数据获取" class="headerlink" title="2.1 数据获取"></a>2.1 数据获取</h2><p>本文通过JoinQuant平台 获取中证全指及沪深300、中证500指数样本股在2014年1月1日至2018年7月31日期间每个交易日的截面数据作为测试集样本。另外，当天停牌或者开盘涨跌停的样本股作为对象外。</p><h2 id="2-2-因子选取与模型构建"><a href="#2-2-因子选取与模型构建" class="headerlink" title="2.2 因子选取与模型构建"></a>2.2 因子选取与模型构建</h2><h3 id="2-2-1-因子选取"><a href="#2-2-1-因子选取" class="headerlink" title="2.2.1 因子选取"></a>2.2.1 因子选取</h3><p>本文经过对因子的相关性等方面的测试和综合考虑，分别从估值，资本结构，盈利，成长四个方面进行考虑，选取如表1所示的因子作为候选因子。</p><p><img src="https://image.joinquant.com/beb8d07b6d4202cef6f54219e3aa2f6b" alt="表1.png"></p><h3 id="2-2-2-模型构建"><a href="#2-2-2-模型构建" class="headerlink" title="2.2.2 模型构建"></a>2.2.2 模型构建</h3><p>从xfy先生的研究中，我们能够看出，某个时间点上，股票的市值可以被多个因素解释。根据多因子模型的基本思路，我们在截面上将市值作为样本标签，按照上述表1所示因子，计算其因子暴露度，作为样本的原始特征。对表1的多个因子进行回归，得到的残差值越小，说明股票市值向下偏离其理论值越严重，也就意味着该股票未来上涨的可能性越大，即收益率越高。构建模型如下所示：</p><p><img src="https://image.joinquant.com/4978ab6f6125baf227cf868b21fe9ed7" alt="公式1.png"></p><h2 id="2-3-数据预处理"><a href="#2-3-数据预处理" class="headerlink" title="2.3 数据预处理"></a>2.3 数据预处理</h2><p>本文通过JoinQuant平台获取所需的市值及因子数据。在进行模型构建与分析之前，为了提高数据的质量，需要对数据进行预处理。数据预处理有多种方法，包括数据清理，数据集成，数据变换，数据归约等。本文对数据主要进行以下预处理。</p><h3 id="2-3-1-缺失值处理"><a href="#2-3-1-缺失值处理" class="headerlink" title="2.3.1 缺失值处理"></a>2.3.1 缺失值处理</h3><p>对于初始数据存在缺失的情况，本文统一用0来填充。</p><h3 id="2-3-2-离群值处理"><a href="#2-3-2-离群值处理" class="headerlink" title="2.3.2 离群值处理"></a>2.3.2 离群值处理</h3><p>因为过大或过小的因子数据可能会影响到分析结果，尤其是在做回归的时候，我们需要对因子的离群值进行处理。处理方法是调整因子值中的离群值至上下限（Winsorzation处理），其中上下限由离群值判断的标准给出，从而减小离群值的影响力。离群值的判断标准有三种，分别为MAD、3σ、百分位法。本文统一采用MAD（n=5）标准对因子进行离群值处理。离群值处理前后的比较，以因子g在2018年7月11日截面数据为例，参考图1所示。</p><p><img src="https://image.joinquant.com/c10fb5f297fb4cdb5aa59cbb37f3a376" alt="图1.png"></p><h3 id="2-3-3-标准化处理"><a href="#2-3-3-标准化处理" class="headerlink" title="2.3.3 标准化处理"></a>2.3.3 标准化处理</h3><p>由于不同因子所描述的对象单位不一样，那么可能导致不同因子数值差异很大，举个例子，如果我们用不经过标准化的市值作为因子暴露，如果公司A的市值是B的市值的100倍，那是否代表我们能说市值因子的收益率对A的收益率的影响是对B的收益率的影响的100倍呢？显然是不能的。所以，在利用因子进行策略建立之前，需要先对因子进行标准化处理。标准化的方法有很多，本文采用z-score的方法，参考图2所示，将因子值的均值调整为0，标准差调整为1。处理后的数据从有量纲转化为无量纲，从而使得数据更加集中，或者使得不同的指标能够进行比较和回归。</p><p><img src="https://image.joinquant.com/046ca2631c971276dea8436a6e2896b0" alt="图2.png"></p><p>以因子log_NC在2018年7月11日截面数据为例，标准化处理的前后比较参考图3所示。</p><p><img src="https://image.joinquant.com/2c0ee10f1000de68a36c7e38ba2a5e79" alt="图3.png"></p><h3 id="2-3-4-中性化处理"><a href="#2-3-4-中性化处理" class="headerlink" title="2.3.4 中性化处理"></a>2.3.4 中性化处理</h3><p>在使用因子进行选股时，有时会因为其它因子的影响，而导致选出来的股票具有一些我们不希望看到的偏向。另一方面，朝阳行业和夕阳行业的市盈率在大致上也有一定的特点，也就是说行业对估值因子也有影响，那么我们得到的结果是具有一些多余偏好的。为了解决这一由于不同行业和市值大小导致的误差问题，让我们在用某一因子时能剔除其他因素的影响，使得选出的股票更加分散，我们需要对其进行中性化处理。<br>对于因子来说，市场风险（例如牛市和熊市）和行业风险（同一行业的公司受的影响类似）是中性化主要考虑的因素，对这两者的处理方式有两种：<br>1，将市场因子和行业因子同时纳入模型。<br>2，仅纳入行业因子，而将市场因子包含在行业因子中。<br>第一种方式和第二种方式的区别在于，第一种方式行业因子收益率计算出来的是行业相对于市场的超额收益率，而第二种方式计算出来的收益率是行业绝对收益率。对于验证风格因子有效性而言，这两种方式是没有区别的；对于回归而言，只是前者是带截距项的回归，而后者是穿越原点的回归。本文采取第二种方式，模型调整如下所示：</p><p><img src="https://image.joinquant.com/aef69434fe114f51a29c802ca6c1de46" alt="公式2.png"></p><p>式中：<br>IND——行业虚拟变量矩阵。若该公司属于该行业，则将该行业的虚拟变量的值设为1，否则设为0。本文不对公司所属行业进行比例拆分，即公司只能属于一个特定的行业。本文的行业划分采用JoinQuant行业1级分类。<a href="https://www.joinquant.com/help/api/help?name=plateData#%E8%81%9A%E5%AE%BD%E8%A1%8C%E4%B8%9A">https://www.joinquant.com/help/api/help?name=plateData#聚宽行业</a></p><h1 id="3-实证分析"><a href="#3-实证分析" class="headerlink" title="3.实证分析"></a>3.实证分析</h1><h2 id="3-1-回测参数设置"><a href="#3-1-回测参数设置" class="headerlink" title="3.1 回测参数设置"></a>3.1 回测参数设置</h2><p>本文采用历史回测的方式进行实证分析。回测参数设置的不同所得到的测试结果差异很大，客观设置回测参数关系到策略交易效果的真伪和对策略的最终取舍。本文的回测参数设置及全局设定参考如下。<br>（一）投资金额<br>假定投资金额为：100万。<br>（二）回测区间<br>未指定的情况下，默认回测区间为：2014年1月1日—2018年7月31日<br>（三）佣金及印花税<br>为了使回测结果更加接近真实的交易成本，在实证分析中，设置佣金及印花税的比例。<br>近十年印花税的主要两次变化包括：<br>1)2008年4月24号起，由3‰调整为1‰。<br>2)2008年9月19日起，由双边征收改为单边征收，税率保持1‰。由出让方按1‰的税率缴纳股票交易印花税，受让方不再征收。<br>佣金方面，由于券商及客户本身的不同，佣金比率各自不同。佣金及印花税的设定参考表2设置。</p><p><img src="https://image.joinquant.com/752f5e858b4e94291a45791009d70e7d" alt="表2.png"></p><p>（四）滑点<br>所谓滑点，是指下单价与实际成交价之间的差价。由于滑点对最终结果的影响较小，本文滑点设定为0。<br>（五）仓位<br>根据每次买入时所剩资金，按照买入股票数平均资金，全仓买入。<br>（六）可行股票池<br>如无特别指定的情况，本文的可行股票池默认为中证全指。实际情况中，当天停牌的股票是无法进行买卖操作的，所以在整体回测前，将当日停牌的股票剔除。另外，本文在跌停状态下策略不进行买入，涨停状态下策略不进行卖出。<br>（七）比较基准<br>对应可行股票池，选取中证全指的每日价格作为判断策略好坏和一系列风险值计算的基准。<br>（八）测试集提取<br>交易日当天的因子特征值为样本的原始特征，当天的市值对数为样本的标签。<br>（九）训练集（包括验证集）合成<br>以T日为例，每21个交易日为间隔，在没有特别指定的情况下，默认使用T-21至T-63的特征和标签作为训练集（包含验证集），且使用3折交叉验证的方法。<br>（十）机器学习算法参数设置<br>在没有特定指定的情况下，各机器学习算法的参数设置参考表3所示，使用固定参数的方式。</p><p><img src="https://image.joinquant.com/8f2d1a697a2440db369705dabe8163b7" alt="表3.png"></p><p>（十一）其他<br>1)回测使用市价单下单，并假设不存在买不到或卖不出的现象。<br>2)财报和市值数据使用的回测日的前一天数据，从而避免未来函数。</p><h2 id="3-2-模型及因子有效性实证"><a href="#3-2-模型及因子有效性实证" class="headerlink" title="3.2 模型及因子有效性实证"></a>3.2 模型及因子有效性实证</h2><p>在对策略进行深入的研究之前，首先对策略进行有效性的研究及实证，以保证之后的研究在正确的前提下进行。对策略的有效性实证方法如下：<br>1.根据线性回归算法，对模型中的因子特征值对市值（取对数）标签做线性回归，取实际值与预测值之差作为新的因子特征值。<br>2.按照差值从小到大的顺序对股票进行排序。<br>3.将股票等分为10组，分别按照每10天和每30天进行一次调仓。<br>根据上述方法，回测条件参考表4所示，进行分组回测。分组回测的结果分别参考表5、图4(中证全指，调仓周期：10天)、图5(中证全指，调仓周期：10天)所示。</p><p><img src="https://image.joinquant.com/3e977e99b0388e55ccb73e9364b673d0" alt="表4.png"></p><p><img src="https://image.joinquant.com/313b7bf1dd549a4a4512e034fa8b502a" alt="表5.png"></p><p><img src="https://image.joinquant.com/b964e7769a392a22f2578222ce5e0c3b" alt="图4.png"></p><p><img src="https://image.joinquant.com/c44e78d6067d62946fd8847271d3d21a" alt="图5.png"></p><p>由表5、图4、图5可知：<br>1.根据假定的模型，沪深300不能得到明显的单调的策略收益率，而中证全指能得到相对明显的单调的策略收益率。中证500则居于沪深300和中证全指中间。说明该策略不适合用于投资沪深300，但可以用于投资中证全指或者中证500。<br>2.中证全指不仅能得到相对明显的单调的策略收益率，还可以获得相对单调的夏普比率和信息比率。<br>3.中证全指不能获得单调的最大回测，说明该模型在风险控制上并没有有效的机制。</p><p>以中证全指为股票池，按照每30日进行一次调仓，分别采用岭回归，SVR和随机森林算法进行分组回测。回测条件参考表6所示，回测结果参考表7所示。</p><p><img src="https://image.joinquant.com/5daf0036e43fc14883708e2e656a03ba" alt="表6.png"></p><p><img src="https://image.joinquant.com/0d733d43dea3664b87b35431e5116ed7" alt="表7.png"></p><p>从表7可知，仅从收益角度看，岭回归，SVR和随机森林三种算法，和线性回归类似，也能够得到相对明显的单调的策略收益率。其中，SVR的趋势最为明显。随机森林的趋势不够显著，在头尾的收益率分水岭比较清晰，在中间分组的分水岭比较模糊。</p><h2 id="3-3-不同因子组合的算法实证比较"><a href="#3-3-不同因子组合的算法实证比较" class="headerlink" title="3.3 不同因子组合的算法实证比较"></a>3.3 不同因子组合的算法实证比较</h2><p>将全部因子分成三种不同的因子组合，参考表8所示。</p><p><img src="https://image.joinquant.com/68695d6c7d1037d03c63c9310bcabdcd" alt="表8.png"></p><p>利用不同算法下，买入排序后前50名股票。每30日进行一次调仓。回测条件参考表9所示。</p><p><img src="https://image.joinquant.com/a6246f74973b370767a5df0a07381b79" alt="表9.png"></p><p>根据上述方法，利用不同的算法进行回测，回测结果参考表10所示：</p><p><img src="https://image.joinquant.com/86398f78e9325f91aad54ed31cddc169" alt="表10.png"></p><p><img src="https://image.joinquant.com/7bf5f3dcea379ead3ea254fccf1973f4" alt="图6.png"></p><p><img src="https://image.joinquant.com/4633fb590808b87d11c2be733c252278" alt="图7.png"></p><p>由表10、图6、图7(因子组合3)可知：<br>1.收益和风险的平衡最理想的策略是采用全因子组合的SVR算法策略，该策略的收益率为243%，夏普比率为0.987，IR为1.742。该三项指标在所有投资组合中表现最好，而其最大回测与其他投资组合持平，甚至更低。<br>2.长期来看，该投资策略在不同的算法皆能跑赢基准。在该投资策略下，总体上看，收益率表现最好的是SVR。SVR最低的收益率也比岭回归及线性回归最高的收益率要略高。其次是随机森林，而岭回归和线性回归不相伯仲。<br>3.随着因子数的增多，线性回归，岭回归的收益率反而下降，而SVR随着因子数的增多，收益率上升。随机森林的收益率表现不稳定。夏普比率和IR的表现和收益率相似。<br>4.不同的因子组合在不同的算法下，最大回测相差不大，没有一种算法也没有一种因子组合有特别的优势。这说明该投资策略本身在风险控制上存在着不足。<br>5.从测试集及验证集的打分来看，随机森林的模型拟合程度最高，预测准确度最高。SVR的拟合程度表现不稳定。线性回归和岭回归的拟合程度基本一致。<br>6.随着因子数的增多，线性回归，岭回归，随机森林的打分越来越高，说明随着因子数的增加，其拟合程度越来越高。SVR打分和因子数没有明显的关系。SVR也是验证集打分与测试集打分的差别最大。</p><h2 id="3-4-不同持仓数的算法实证比较"><a href="#3-4-不同持仓数的算法实证比较" class="headerlink" title="3.4 不同持仓数的算法实证比较"></a>3.4 不同持仓数的算法实证比较</h2><p>本文为了分析并实证不同持仓数下的收益和风险的不同表现，按照表8所示的因子组合3（全因子组合），将持仓数分别设置为5、10、30、50，进行回测，详细的回测条件参考表11所示，</p><p><img src="https://image.joinquant.com/4c83a648d630f576710329c3e881ae13" alt="表11.png"></p><p>回测结果参考表12所示，</p><p><img src="https://image.joinquant.com/d33ddd797c5dd2392858bdfe4a23cb50" alt="表12.png"></p><p>从表12可知，<br>1.收益表现最好的是SVR算法（持仓数为5）的情况，该算法实现了698%的最高收益率，夏普比率和IR也达到最高，分别为1.61和2.03。但是该算法的最大回测也非常高，超过了50%，策略波动率远高于基准波动率。如果考虑最大回测不要超过50%的话，SVR算法（持仓数为30）的情况最为理想，该算法实现了263%的收益率，普遍高于其他情况，夏普比率为1.07，也普遍高于其他情况。而该持仓数下，最大回测下降到44%，接近于平均值。<br>2.在相同持仓数下，收益率及夏普比率排名大致保持SVR&gt;随机森林&gt;岭回归&gt;线性回归的顺序。<br>3.随着持仓数减少，各个算法的收益率都有上升，SVR上升最为明显。由此可见，持仓越分散，收益越容易被平摊。而策略波动率则刚刚相反。持仓越集中，波动越大。<br>4.线性回归和岭回归随着持仓数减少，最大回测出现了逐渐缩小迹象。其中岭回归在持仓数为5的时候最大回测达到最小，盈亏比达到最大；与之相反，SVR和随机森林随着持仓数减少，最大回测出现明显扩大。<br>5.结合收益和风险的指标，利用线性回归和岭回归算法时，最佳持仓数为5，利用SVR和随机森林算法时，最佳持仓数为30。</p><h2 id="3-5-不同市场风格的算法实证比较"><a href="#3-5-不同市场风格的算法实证比较" class="headerlink" title="3.5 不同市场风格的算法实证比较"></a>3.5 不同市场风格的算法实证比较</h2><p>根据不同的市场的风格之间的切换，设置不同的回测区间，参考表13所示。</p><p><img src="https://image.joinquant.com/a8791a8e10669a9393c0711836c7be01" alt="表13.png"></p><p>回测条件参考表14所示，</p><p><img src="https://image.joinquant.com/23855cf7f7d8f77f0e83bc1847608026" alt="表14.png"></p><p>回测结果参考表15所示，</p><p><img src="https://image.joinquant.com/9aa82ece2d20346330ba168ee5cf80bc" alt="表15.png"></p><p>为了更加清晰地比较不同算法的收益和风险，对表15进行简化，参考表16（年化收益排名）、表17（最大回测排名）所示。</p><p><img src="https://image.joinquant.com/99a37c1ad9a7eccbe389cc5674693575" alt="表16.png"></p><p><img src="https://image.joinquant.com/3a0ca8447a5eb286da69d8bdb3e8db75" alt="表17.png"></p><p>从表16、表17可知，<br>1.从收益来看，在市场风格没有大的切换的期间，整体而言，线性模型要优于SVR和随机森林算法。在市场长期盘整阶段，SVR和随机森林算法基本失效。在长期盘整走势当中应该谨慎用机器学习算法进行量化投资的指导，此时更应该结合其他技术分析理论进行投资决策辅助。在持续下跌的市场环境中，SVR算法也能获得超额收益。<br>2.从收益来看，在市场风格出现明显切换的期间，SVR和随机森林算法整体而言要优于线性模型，SVR算法尤其突出。但是在市场风格由盘整切换到下跌期间，SVR和随机森林算法基本失效。<br>3.从风险来看，在市场风格没有大的切换的期间，线性模型整体而言要优于SVR和随机森林算法。在持续上涨阶段，SVR和随机森林算法基本能赶上线性模型，其他情况下，其风险远高于线性模型。<br>3.从风险来看，在市场风格出现明显切换的期间，并没有什么算法表现出特别高的风险预测能力。<br>4.总体而言，市场风格没有大的切换的期间，线性模型优于SVR和随机森林算法，反之，SVR算法更优（市场风格由盘整切换到下跌期间除外）。</p><h2 id="3-6-不同参数的算法实证比较"><a href="#3-6-不同参数的算法实证比较" class="headerlink" title="3.6 不同参数的算法实证比较"></a>3.6 不同参数的算法实证比较</h2><p>以中证全指为可行股票池，持仓数为5，分别使用固定参数和网格搜索（带标准3折交叉验证）的方法来验证不同参数的模型泛化程度并调节监督模型参数以获得最佳泛化性能。回测条件参考表18所示，算法参数参考表19所示，</p><p><img src="https://image.joinquant.com/fa66aa774c35fd0ba2053016ee80051e" alt="表18.png"></p><p><img src="https://image.joinquant.com/4a09c06d877d464e8d341b2f4bfe9bf1" alt="表19.png"></p><p>回测结果参考表20所示，</p><p><img src="https://image.joinquant.com/308c2d6b244cb29abb42538b366fa5e4" alt="表20.png"></p><p>由表20可知：<br>1.岭回归采用不同的参数设置方式下，固定参数的收益率高于网格搜索的收益率。而SVR和随机森林表现不稳定。<br>2.岭回归和随机森林的模型拟合程度（测试集打分）在不同参数的设置方式下，网格搜索相对于固定参数而言，没有明显的提升。而SVR的网格搜索的测试集打分则显著优于固定参数的打分。<br>3.总体而言，使用网格搜索可以使SVR的模型拟合度更高。但是，使用网格搜索并不能带来收益率的显著上升，甚至导致收益率的下降。</p><h2 id="3-7-不同训练集长度的算法实证比较"><a href="#3-7-不同训练集长度的算法实证比较" class="headerlink" title="3.7 不同训练集长度的算法实证比较"></a>3.7 不同训练集长度的算法实证比较</h2><p>调节滚动训练集的长度，回测条件参考表21所示，进行回测。回测结果参考表22所示：</p><p><img src="https://image.joinquant.com/f3744f8af0bda3cf679f140dde0093ba" alt="表21.png"></p><p><img src="https://image.joinquant.com/b32c23a8ad0ea9b9a80161bbe33a7d21" alt="表22.png"></p><p>由表22可知，<br>1.收益表现最好的是SVR算法（训练集长度：3）。该策略的夏普比率和信息比率也是最优的。<br>2.从收益来看，增加训练集长度，并不一定能带来收益率的增加。线性回归，岭回归，SVR表现最佳的训练集长度是3，随机森林表现最佳的训练集长度为9。<br>3.从风险来看，增加训练集长度，并不一定能降低风险。线性回归，岭回归算法随着训练集长度的增加，最大回测有下降趋势。SVR，随机森林表现不稳定。</p><h1 id="4-结论"><a href="#4-结论" class="headerlink" title="4.结论"></a>4.结论</h1><h2 id="4-1-总结"><a href="#4-1-总结" class="headerlink" title="4.1 总结"></a>4.1 总结</h2><p>1.本文构建的量化选股模型在2014年1月-2018年7月间累计收益率最高可达到698%（SVR算法，持仓数为5的情况），年化收益率达到59%，远远超出同期比较基准（中证全指）的业绩表现（收益率：42%），可见本文的策略具有较好的选股效果。<br>2.通过分组回测比较分析可以发现，在中证全指的情况下，策略业绩随着分位组变化具有显著的递减趋势，说明该模型在投资中证全指成分股时能够有效区分强势股和弱势股。<br>3.与线性模型（线性回归和岭回归）对比分析可以发现，本文的投资策略通过非线性模型（SVR和随机森林）可以不断适应市场环境的变化，可以更好地挖掘具有超额收益的股票。非线性模型在收益率、夏普比率和信息比率方面表现不错，基于非线性模型选股的投资策略能稳定地优于线性模型；从回撤的角度看，非线性模型相比于线性模型不具备明显优势，有些时候回撤与线性模型持平甚至大于线性模型。<br>4.随机森林和SVR相比，虽然在个别的情况下，随机森林比SVR能获取更高的超额收益，但是从整体来看，随机森林的收益率要低于SVR。但是，在本文因子条件下，随机森林的预测能力毋庸置疑远胜于SVR。<br>5.具有正则化优势的岭回归相比线性回归对策略没有明显的提升作用。我们分析有两个可能的原因。首先，随着模型的可用数据越来越多，两个模型的性能都在提升，最终线性回归的性能追上了岭回归。反过来同时验证了如果有足够多的训练数据，正则化变得不那么重要，并且岭回归和线性回归将具有相同的性能。其次，由于预处理过程中做了去极值和标准化，在降低因子多重共线性的同时减少了极端样本的出现概率，因而进一步削弱了正则化的价值。所以，在本文的策略中，正则化并没有对收益率等指标产生明显的帮助。<br>随着因子数的增多，不管是哪种算法，整体上，拟合度和收益率出现了反向关系。两者刚好相反的原因可以解释如下：由于本文的量化投资策略是以购买偏离预测值下方最多的股票为投资标的，所以拟合度不高的算法反而更容易发现那些实际值与预测值偏差过大的股票，从而更能精准地买入。<br>6.不同的因子组合，不同的持仓数对策略表现具有一定的影响。线性模型在因子增多时收益率下降。非线性模型在因子增多时更具有收益能力。持仓数越少收益率越高，风险也随之增大。<br>7.在本文，我们将市场风格划分为9种，并实证了其中7种不同市场风格，分别是持续盘整，持续上涨，持续下跌，盘整—上涨切换，盘整—下跌切换，上涨—下跌切换，下跌—上涨切换。每种市场风格都测试了用机器学习算法对于收益率和最大回测的情况。根据测试结果显示：在市场风格没有大的切换时候，线性模型的算法要优于SVR和随机森林的算法，反之，SVR表现最佳，且该算法的收益远胜于其他算法。<br>8.关于在算法优化方面，不管是采用网格搜索的方法来优化算法的参数，还是采用增加滚动训练集长度的方法来优化模型泛化程度，都不能带来收益率的明显上升，甚至下降。SVR算法的收益率对是否使用网格搜索或者说参数值的敏感度很高，在使用SVR算法时要充分讨论其参数的合理性。从收益率和夏普比率的角度来看，线性模型，SVR算法的回测效果最佳的滚动训练集长度是3个交易月，随机森林算法的回测效果最佳的滚动训练集长度是9个交易月。</p><h2 id="4-2-不足之处"><a href="#4-2-不足之处" class="headerlink" title="4.2 不足之处"></a>4.2 不足之处</h2><p>本文在传统的多因子模型的基础上，引入机器学习选股，试图建立更加有效的量化选股策略，但仍然存在以下的几点不足：<br>1.本文的策略在风险控制上显得不足，尤其是2015年牛熊市的市场风格切换异常迅速，本文的量化投资策略在市场高风险时没能考虑止损等风险控制，导致最大回撤较大。如能加入止盈止损条件或引入择时模型对股票的买卖时机以及仓位进行判断，或利用对冲机制对风险进行对冲，有望能控制风险。由于时间的关系，本文在这方面没有做深度研究。<br>2.本文在使用多因子模型时，使用的因子的范围比较窄，主要基于基本面。基本面以外，比如技术面的因子并没有考虑进来。<br>3.由于实际条件的限制，本文的量化投资策略的评价主要基于历史数据的回测结果进行比较和评估，没有后续的实盘模拟及实时交易跟踪。本文的策略还有待于在实盘交易中进行进一步的验证。</p>]]></content>
      
      
      
        <tags>
            
            <tag> stock </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="//post/hello-world.html"/>
      <url>//post/hello-world.html</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo deploy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> home </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
